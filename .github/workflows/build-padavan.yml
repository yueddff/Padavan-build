name: Build Padavan Firmware

on:
  workflow_dispatch:
    inputs:
      device_type:
        description: 'é€‰æ‹©è®¾å¤‡å‹å·'
        required: true
        default: 'K2P'
        type: choice
        options:
          - K2P
          - JDC-1
          - PSG1218
          - NEWIFI3
          - RM2100
          - DIR-882
          - MI-3
          - MI-4
          - MI-R3G
      include_plugins:
        description: 'åŒ…å«æ’ä»¶ç±»å‹'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - full
          - minimal

env:
  KERNEL_VERSION: 3.4
  TOOLCHAIN_DIR: /opt/rt-n56u/toolchain-mipsel

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup environment variables
      id: setup-env
      run: |
        echo "TNAME=${{ github.event.inputs.device_type }}" >> $GITHUB_ENV
        echo "PLUGIN_TYPE=${{ github.event.inputs.include_plugins }}" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
        echo "Selected device: $TNAME"
        echo "Plugin type: $PLUGIN_TYPE"
        echo "Build date: $BUILD_DATE"

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          unzip libtool-bin curl cmake gperf gawk flex bison nano xxd \
          fakeroot cpio git python3 python3-pip python3-docutils \
          gettext automake autopoint texinfo build-essential help2man \
          pkg-config zlib1g-dev libgmp3-dev libmpc-dev libmpfr-dev \
          libncurses5-dev libncursesw5-dev libltdl-dev wget patch \
          libssl-dev device-tree-compiler acpica-tools

    - name: Clone Padavan source code
      run: |
        echo "æ­£åœ¨å…‹éš† Padavan æºç ..."
        git clone --depth=1 https://github.com/vb1980/Padavan-KVR /opt/rt-n56u
        ls -la /opt/rt-n56u/

    - name: Download and setup toolchain
      run: |
        echo "è®¾ç½®ç¼–è¯‘å·¥å…·é“¾..."
        cd /opt/rt-n56u/toolchain-mipsel
        bash dl_toolchain.sh
        echo "å·¥å…·é“¾ç‰ˆæœ¬ä¿¡æ¯:"
        /opt/rt-n56u/toolchain-mipsel/toolchain-mipsel/bin/mipsel-linux-uclibc-gcc --version || echo "å·¥å…·é“¾éœ€è¦ç¼–è¯‘"

    - name: Fix known build issues
      run: |
        echo "ä¿®å¤å·²çŸ¥çš„ç¼–è¯‘é—®é¢˜..."
        cd /opt/rt-n56u/trunk

        # ä¿®å¤ libncurses è¡¥ä¸é—®é¢˜
        if [ -f libs/libncurses/misc/run_tic.in ]; then
          echo "ä¿®å¤ run_tic.in è¡¥ä¸é—®é¢˜..."
          cd libs/libncurses
          cp misc/run_tic.in misc/run_tic.in.original
          
          # æ‰‹åŠ¨åº”ç”¨è¡¥ä¸å†…å®¹
          sed -i 's|@TIC@|tic|g' misc/run_tic.in
          sed -i 's|@DATADIR@|/usr/share|g' misc/run_tic.in
          sed -i 's|@TERMINFO@|/usr/share/terminfo|g' misc/run_tic.in
          
          # ç¡®ä¿æ–‡ä»¶å¯æ‰§è¡Œ
          chmod +x misc/run_tic.in
          cd ../..
        fi

        # æ¸…ç†è¡¥ä¸æ®‹ç•™æ–‡ä»¶
        find . -name "*.rej" -delete 2>/dev/null || true
        find . -name "*.orig" -delete 2>/dev/null || true
        find . -name "*.patch" -exec sh -c 'echo "æ£€æŸ¥è¡¥ä¸: {}" && patch --dry-run -p1 < {} 2>/dev/null || true' \;

        # è®¾ç½®ç¯å¢ƒå˜é‡
        export STAGING_DIR=/opt/rt-n56u/toolchain-mipsel/toolchain-mipsel
        export PATH=$STAGING_DIR/bin:$PATH

    - name: Configure build parameters
      run: |
        cd /opt/rt-n56u/trunk
        echo "é…ç½® $TNAME çš„ç¼–è¯‘å‚æ•°..."

        # éªŒè¯é…ç½®æ–‡ä»¶å­˜åœ¨
        if [ ! -f "configs/templates/$TNAME.config" ]; then
          echo "âŒ é”™è¯¯: configs/templates/$TNAME.config ä¸å­˜åœ¨!"
          echo "å¯ç”¨çš„é…ç½®æ–‡ä»¶:"
          ls configs/templates/ | head -20
          exit 1
        fi

        # å¤åˆ¶åŸºç¡€é…ç½®æ–‡ä»¶
        cp -f configs/templates/$TNAME.config .config

        # åŸºç¡€é…ç½®ä¿®æ”¹
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config

        # æ¸…ç†æ—§é…ç½®é¡¹
        CONFIG_ITEMS=(
          "MENTOHUST" "SCUTCLIENT" "SHADOWSOCKS" "SSSERVER" "DNSFORWARDER"
          "ADBYBY" "FRPC" "FRPS" "TUNSAFE" "ALIDDNS" "SMARTDNS" "SRELAY"
          "KOOLPROXY" "CADDY" "ADGUARDHOME" "WYY" "ZEROTIER" "V2RAY" "TROJAN"
          "SSOBFS" "XRAY" "DDNSTO" "ALDRIVER"
        )

        for item in "${CONFIG_ITEMS[@]}"; do
          sed -i "/CONFIG_FIRMWARE_INCLUDE_${item}/d" .config
        done

    - name: Apply plugin configuration
      run: |
        cd /opt/rt-n56u/trunk
        echo "åº”ç”¨ $PLUGIN_TYPE æ’ä»¶é…ç½®..."

        if [ "$PLUGIN_TYPE" = "minimal" ]; then
          cat >> .config << 'EOF'
# æœ€å°åŒ–é…ç½® - åªåŒ…å«åŸºç¡€åŠŸèƒ½
CONFIG_FIRMWARE_INCLUDE_MENTOHUST=n
CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=n
CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n
CONFIG_FIRMWARE_INCLUDE_SSSERVER=n
CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER=n
CONFIG_FIRMWARE_INCLUDE_ADBYBY=n
CONFIG_FIRMWARE_INCLUDE_FRPC=n
CONFIG_FIRMWARE_INCLUDE_FRPS=n
CONFIG_FIRMWARE_INCLUDE_TUNSAFE=n
CONFIG_FIRMWARE_INCLUDE_ALIDDNS=y
CONFIG_FIRMWARE_INCLUDE_SMARTDNS=n
CONFIG_FIRMWARE_INCLUDE_SRELAY=n
EOF

        elif [ "$PLUGIN_TYPE" = "basic" ]; then
          cat >> .config << 'EOF'
# åŸºç¡€é…ç½® - å¸¸ç”¨åŠŸèƒ½
CONFIG_FIRMWARE_INCLUDE_MENTOHUST=n
CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=n
CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y
CONFIG_FIRMWARE_INCLUDE_SSOBFS=n
CONFIG_FIRMWARE_INCLUDE_SSSERVER=n
CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER=n
CONFIG_FIRMWARE_INCLUDE_ADBYBY=y
CONFIG_FIRMWARE_INCLUDE_FRPC=n
CONFIG_FIRMWARE_INCLUDE_FRPS=n
CONFIG_FIRMWARE_INCLUDE_TUNSAFE=n
CONFIG_FIRMWARE_INCLUDE_ALIDDNS=y
CONFIG_FIRMWARE_INCLUDE_SMARTDNS=y
CONFIG_FIRMWARE_INCLUDE_SMARTDNSBIN=y
CONFIG_FIRMWARE_INCLUDE_V2RAY=n
CONFIG_FIRMWARE_INCLUDE_TROJAN=n
CONFIG_FIRMWARE_INCLUDE_KOOLPROXY=y
CONFIG_FIRMWARE_INCLUDE_CADDY=n
CONFIG_FIRMWARE_INCLUDE_ADGUARDHOME=y
CONFIG_FIRMWARE_INCLUDE_SRELAY=n
CONFIG_FIRMWARE_INCLUDE_WYY=y
CONFIG_FIRMWARE_INCLUDE_WYYBIN=n
CONFIG_FIRMWARE_INCLUDE_ZEROTIER=n
EOF

        else  # full configuration
          cat >> .config << 'EOF'
# å®Œæ•´é…ç½® - æ‰€æœ‰åŠŸèƒ½
CONFIG_FIRMWARE_INCLUDE_MENTOHUST=n
CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=n
CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y
CONFIG_FIRMWARE_INCLUDE_SSOBFS=y
CONFIG_FIRMWARE_INCLUDE_SSSERVER=n
CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER=n
CONFIG_FIRMWARE_INCLUDE_ADBYBY=y
CONFIG_FIRMWARE_INCLUDE_FRPC=y
CONFIG_FIRMWARE_INCLUDE_FRPS=n
CONFIG_FIRMWARE_INCLUDE_TUNSAFE=n
CONFIG_FIRMWARE_INCLUDE_ALIDDNS=y
CONFIG_FIRMWARE_INCLUDE_SMARTDNS=y
CONFIG_FIRMWARE_INCLUDE_SMARTDNSBIN=y
CONFIG_FIRMWARE_INCLUDE_V2RAY=n
CONFIG_FIRMWARE_INCLUDE_TROJAN=n
CONFIG_FIRMWARE_INCLUDE_KOOLPROXY=y
CONFIG_FIRMWARE_INCLUDE_CADDY=y
CONFIG_FIRMWARE_INCLUDE_CADDYBIN=n
CONFIG_FIRMWARE_INCLUDE_ADGUARDHOME=y
CONFIG_FIRMWARE_INCLUDE_SRELAY=n
CONFIG_FIRMWARE_INCLUDE_WYY=y
CONFIG_FIRMWARE_INCLUDE_WYYBIN=n
CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y
CONFIG_FIRMWARE_INCLUDE_XRAY=n
CONFIG_FIRMWARE_INCLUDE_DDNSTO=y
EOF
        fi

        echo "æœ€ç»ˆé…ç½®æ‘˜è¦:"
        grep "^CONFIG_FIRMWARE_INCLUDE_" .config | sort

    - name: Build firmware
      id: build
      run: |
        cd /opt/rt-n56u/trunk
        echo "å¼€å§‹ç¼–è¯‘ $TNAME å›ºä»¶..."

        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export STAGING_DIR=/opt/rt-n56u/toolchain-mipsel/toolchain-mipsel
        export PATH=$STAGING_DIR/bin:$PATH
        
        # æ£€æŸ¥å·¥å…·é“¾
        echo "æ£€æŸ¥ç¼–è¯‘å·¥å…·é“¾..."
        which mipsel-linux-uclibc-gcc || echo "å·¥å…·é“¾æœªæ‰¾åˆ°ï¼Œå°è¯•ç»§ç»­ç¼–è¯‘"

        # æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘ç»“æœ
        sudo ./clear_tree

        # å¼€å§‹ç¼–è¯‘
        echo "ç¼–è¯‘æ—¥å¿—å¼€å§‹..."
        if sudo ./build_firmware_modify $TNAME 0 2>&1 | tee build.log; then
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ!"
          
          # æ£€æŸ¥ç”Ÿæˆçš„å›ºä»¶
          if ls images/*.trx images/*.bin 2>/dev/null; then
            mkdir -p /opt/images
            sudo mv -f images/*.trx images/*.bin /opt/images/ 2>/dev/null || true
            echo "firmware_built=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç¼–è¯‘æˆåŠŸä½†æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
            exit 1
          fi
        else
          echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥!"
          echo "æœ€å100è¡Œç¼–è¯‘æ—¥å¿—:"
          tail -100 build.log || true
          exit 1
        fi

    - name: Collect build artifacts
      if: steps.build.outputs.firmware_built == 'true'
      run: |
        echo "æ”¶é›†ç¼–è¯‘äº§ç‰©..."
        mkdir -p /tmp/artifacts
        sudo chmod -R a+rw /opt/images/
        
        if ls /opt/images/*.trx /opt/images/*.bin 2>/dev/null; then
          cp /opt/images/* /tmp/artifacts/ 2>/dev/null || true
          echo "ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
          ls -la /tmp/artifacts/
          
          # è®¡ç®—æ–‡ä»¶å¤§å°
          for file in /tmp/artifacts/*; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "å›ºä»¶: $(basename "$file") å¤§å°: $size"
            fi
          done
        else
          echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          exit 1
        fi

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: padavan-${{ env.TNAME }}-${{ env.BUILD_DATE }}
        path: /tmp/artifacts/*
        retention-days: 30
        if-no-files-found: error

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ env.TNAME }}-${{ env.BUILD_DATE }}
        path: /opt/rt-n56u/trunk/build.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Build success notification
      if: success()
      run: |
        echo "ğŸ‰ Padavan å›ºä»¶ç¼–è¯‘æˆåŠŸå®Œæˆ!"
        echo "ğŸ“± è®¾å¤‡å‹å·: ${{ env.TNAME }}"
        echo "ğŸ”§ æ’ä»¶ç±»å‹: ${{ env.PLUGIN_TYPE }}"
        echo "ğŸ“… ç¼–è¯‘æ—¶é—´: ${{ env.BUILD_DATE }}"
        echo "ğŸ“¦ å›ºä»¶æ–‡ä»¶å·²ä¸Šä¼ åˆ° Artifacts"

    - name: Build failure notification
      if: failure()
      run: |
        echo "âŒ Padavan å›ºä»¶ç¼–è¯‘å¤±è´¥"
        echo "ğŸ“± è®¾å¤‡å‹å·: ${{ env.TNAME }}"
        echo "ğŸ”§ æ’ä»¶ç±»å‹: ${{ env.PLUGIN_TYPE }}"
        echo "âš ï¸ è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        echo "ğŸ’¡ å»ºè®®: å°è¯•ä½¿ç”¨ minimal æ’ä»¶é…ç½®é‡æ–°ç¼–è¯‘"
