name: Build Padavan Firmware

on:
  workflow_dispatch:
    inputs:
      device_type:
        description: '选择设备型号'
        required: true
        default: 'K2P'
        type: choice
        options:
          - K2P
          - JDC-1
          - PSG1218
          - NEWIFI3
          - RM2100

env:
  KERNEL_VERSION: "3.4"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup environment variables
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "TNAME=${{ github.event.inputs.device_type }}" >> $GITHUB_ENV
        else
          echo "TNAME=K2P" >> $GITHUB_ENV
        fi
        echo "BUILD_DATE=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
        echo "Selected device: $TNAME"

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip libtool-bin curl cmake gperf gawk flex bison nano xxd
        sudo apt-get install -y fakeroot cpio git python3 python3-pip python3-docutils
        sudo apt-get install -y gettext automake autopoint texinfo build-essential help2man
        sudo apt-get install -y pkg-config zlib1g-dev libgmp3-dev libmpc-dev libmpfr-dev
        sudo apt-get install -y libncurses5-dev libncursesw5-dev libltdl-dev wget patch
        sudo apt-get install -y libssl-dev device-tree-compiler

    - name: Clone Padavan source code
      run: |
        echo "Cloning Padavan source code..."
        git clone --depth=1 https://github.com/hiboyhiboy/rt-n56u /opt/rt-n56u
        ls -la /opt/rt-n56u/

    - name: Download and setup toolchain
      run: |
        echo "Setting up toolchain..."
        cd /opt/rt-n56u/toolchain-mipsel
        bash dl_toolchain.sh

    - name: Fix ncurses build issues
      run: |
        echo "Fixing ncurses build issues..."
        cd /opt/rt-n56u/trunk

        # Fix run_tic.in patch failure
        if [ -f libs/libncurses/misc/run_tic.in ]; then
          cd libs/libncurses
          cp misc/run_tic.in misc/run_tic.in.backup
          sed -i 's|@TIC@|tic|g' misc/run_tic.in
          sed -i 's|@DATADIR@|/usr/share|g' misc/run_tic.in
          sed -i 's|@TERMINFO@|/usr/share/terminfo|g' misc/run_tic.in
          chmod +x misc/run_tic.in
          cd ../..
        fi

        # Clean patch reject files
        find . -name "*.rej" -delete 2>/dev/null || true
        find . -name "*.orig" -delete 2>/dev/null || true

    - name: Configure build
      run: |
        cd /opt/rt-n56u/trunk
        echo "Configuring build for $TNAME"

        # Check if config exists
        if [ ! -f "configs/templates/$TNAME.config" ]; then
          echo "Error: config file configs/templates/$TNAME.config not found!"
          echo "Available configs:"
          ls configs/templates/ || echo "No configs directory"
          exit 1
        fi

        # Copy base config
        cp -f configs/templates/$TNAME.config .config

        # Enable OpenSSL executable
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config

        # Remove existing config items
        sed -i '/CONFIG_FIRMWARE_INCLUDE_MENTOHUST/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SSSERVER/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ADBYBY/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_FRPC/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_FRPS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_TUNSAFE/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ALIDDNS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SMARTDNS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SRELAY/d' .config

        # Add basic configuration
        echo "CONFIG_FIRMWARE_INCLUDE_MENTOHUST=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SSOBFS=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SSSERVER=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ADBYBY=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_FRPC=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_FRPS=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_TUNSAFE=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ALIDDNS=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SMARTDNS=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SMARTDNSBIN=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_V2RAY=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_TROJAN=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_KOOLPROXY=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_CADDY=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_CADDYBIN=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ADGUARDHOME=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SRELAY=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_WYY=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_WYYBIN=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ZEROTIER=n" >> .config

        echo "Configuration applied successfully"

    - name: Build firmware
      run: |
        cd /opt/rt-n56u/trunk
        echo "Building firmware for $TNAME"

        # Set environment
        export STAGING_DIR=/opt/rt-n56u/toolchain-mipsel/toolchain-mipsel
        export PATH=$STAGING_DIR/bin:$PATH

        # Clean previous build
        sudo ./clear_tree

        # Build firmware
        echo "Starting build process..."
        if sudo ./build_firmware_modify $TNAME 0; then
          echo "Firmware build successful!"
          
          # Create output directory
          mkdir -p /opt/images
          
          # Move firmware files
          if ls images/*.trx > /dev/null 2>&1; then
            sudo mv images/*.trx /opt/images/ 2>/dev/null || true
          fi
          if ls images/*.bin > /dev/null 2>&1; then
            sudo mv images/*.bin /opt/images/ 2>/dev/null || true
          fi
        else
          echo "Firmware build failed!"
          exit 1
        fi

    - name: Check build results
      run: |
        echo "Checking build results..."
        if ls /opt/images/*.trx /opt/images/*.bin > /dev/null 2>&1; then
          echo "Firmware files found:"
          ls -la /opt/images/
          echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "No firmware files found"
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: Upload firmware artifacts
      if: env.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: padavan-${{ env.TNAME }}-${{ env.BUILD_DATE }}
        path: /opt/images/
        retention-days: 30

    - name: Build success message
      if: success()
      run: |
        echo "✅ Padavan firmware build completed successfully!"
        echo "Device: ${{ env.TNAME }}"
        echo "Build date: ${{ env.BUILD_DATE }}"
        echo "Firmware files are available in the Artifacts section"

    - name: Build failure message
      if: failure()
      run: |
        echo "❌ Padavan firmware build failed"
        echo "Device: ${{ env.TNAME }}"
        echo "Please check the build logs for details"
