name: Build Padavan

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'Device model'
        required: true
        default: 'JDC-1'
        type: choice
        options:
        - K2P
        - JDC-1

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set device
      run: |
        echo "TNAME=${{ github.event.inputs.device }}" >> $GITHUB_ENV
        
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y unzip libtool curl cmake gperf gawk flex bison nano xxd
        sudo apt install -y fakeroot cpio git python3 gettext automake autopoint
        sudo apt install -y texinfo build-essential pkg-config zlib1g-dev
        sudo apt install -y libgmp3-dev libmpc-dev libmpfr-dev libncurses5-dev
        sudo apt install -y libncursesw5-dev libltdl-dev wget patch
        
    - name: Clone source
      run: |
        git clone --depth=1 https://github.com/vb1980/Padavan-KVR /opt/rt-n56u
        cd /opt/rt-n56u/toolchain-mipsel
        sh dl_toolchain.sh
        
    - name: Fix ncurses
      run: |
        cd /opt/rt-n56u/trunk/libs/libncurses
        [ -f misc/run_tic.in ] && sed -i 's|@TIC@|tic|g; s|@DATADIR@|/usr/share|g' misc/run_tic.in
        
    - name: Build firmware
      run: |
        cd /opt/rt-n56u/trunk
        cp configs/templates/${{ env.TNAME }}.config .config
        sudo ./clear_tree
        sudo ./build_firmware_modify ${{ env.TNAME }} 0
        mkdir -p /tmp/firmware
        sudo cp images/*.trx /tmp/firmware/ 2>/dev/null || true
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: /tmp/firmware/
