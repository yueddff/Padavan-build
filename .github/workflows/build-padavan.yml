name: Build Padavan

on: 
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      device_type:
        description: 'é€‰æ‹©è¦ç¼–è¯‘çš„è®¾å¤‡å‹å·'
        required: true
        default: 'JDC-1'
        type: choice
        options:
          - JDC-1
          - K2P
          - PSG1218
          - NEWIFI3
          - RM2100

env:
  KERNEL: 3.4

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set device type
      id: set-device
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "TNAME=${{ github.event.inputs.device_type }}" >> $GITHUB_ENV
        else
          echo "TNAME=JDC-1" >> $GITHUB_ENV
        fi
        echo "Selected device: $TNAME"

    - name: Install dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          unzip libtool-bin curl cmake gperf gawk flex bison nano xxd fakeroot \
          cpio git python3-docutils gettext automake autopoint texinfo \
          build-essential help2man pkg-config zlib1g-dev libgmp3-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libltdl-dev \
          wget patch

    - name: Clone Padavan source
      run: |
        git clone --depth=1 https://github.com/vb1980/Padavan-KVR /opt/rt-n56u
        cd /opt/rt-n56u/toolchain-mipsel
        sh dl_toolchain.sh
        mkdir -p /opt/images/

    - name: Fix ncurses patch issue
      run: |
        cd /opt/rt-n56u/trunk
        
        echo "ä¿®å¤ ncurses è¡¥ä¸é—®é¢˜..."
        
        # æ£€æŸ¥å¹¶ä¿®å¤ run_tic.in æ–‡ä»¶
        if [ -f libs/libncurses/misc/run_tic.in ]; then
          cd libs/libncurses
          
          # å¤‡ä»½åŸæ–‡ä»¶
          cp misc/run_tic.in misc/run_tic.in.backup
          
          # æ‰‹åŠ¨ä¿®å¤è¡¥ä¸å†…å®¹ - è¿™æ˜¯è§£å†³ run_tic.in è¡¥ä¸å¤±è´¥çš„å…³é”®
          # æ ¹æ®å¸¸è§çš„è¡¥ä¸å¤±è´¥æƒ…å†µï¼Œæ‰‹åŠ¨åº”ç”¨æ‰€éœ€çš„ä¿®æ”¹
          sed -i 's|@TIC@|tic|g' misc/run_tic.in
          sed -i 's|@DATADIR@|/usr/share|g' misc/run_tic.in
          sed -i 's|@TERMINFO@|/usr/share/terminfo|g' misc/run_tic.in
          
          # ä¿®å¤å¯èƒ½çš„æƒé™é—®é¢˜
          chmod +x misc/run_tic.in
          
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„è¡¥ä¸æ‹’ç»æ–‡ä»¶
          find . -name "*.rej" -delete 2>/dev/null || true
          find . -name "*.orig" -delete 2>/dev/null || true
          
          cd ../..
        fi
        
        # æ¸…ç†æ‰€æœ‰è¡¥ä¸æ®‹ç•™
        find . -name "*.rej" -delete 2>/dev/null || true
        find . -name "*.orig" -delete 2>/dev/null || true

    - name: Apply additional fixes
      run: |
        cd /opt/rt-n56u/trunk
        
        # è®¾ç½®ç¯å¢ƒå˜é‡ä»¥é¿å…æŸäº›ç¼–è¯‘é—®é¢˜
        export CPPFLAGS="-P"
        export CFLAGS="-O2 -pipe"
        export CXXFLAGS="-O2 -pipe"
        
        # ä¸ºå·¥å…·é“¾è®¾ç½®è·¯å¾„
        export PATH=/opt/rt-n56u/toolchain-mipsel/toolchain-mipsel/bin:$PATH
        
        echo "ç¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: Build firmware
      id: build
      run: |
        cd /opt/rt-n56u/trunk
        
        echo "æ­£åœ¨ä¸ºè®¾å¤‡ ${{ env.TNAME }} æ„å»ºå›ºä»¶..."
        
        # éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "configs/templates/${{ env.TNAME }}.config" ]; then
          echo "âŒ é”™è¯¯: configs/templates/${{ env.TNAME }}.config ä¸å­˜åœ¨!"
          echo "å¯ç”¨çš„é…ç½®æ–‡ä»¶:"
          ls configs/templates/ 2>/dev/null || echo "configs/templates/ ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp -f configs/templates/${{ env.TNAME }}.config .config
        
        echo "åº”ç”¨é…ç½®ä¿®æ”¹..."
        
        # ç¡®ä¿ OPENSSL å¯æ‰§è¡Œæ–‡ä»¶è¢«åŒ…å«
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config
        
        # åˆ é™¤åŸæœ‰é…ç½®é¡¹
        CONFIG_ITEMS=(
          "MENTOHUST" "SCUTCLIENT" "SHADOWSOCKS" "SSSERVER" "DNSFORWARDER"
          "ADBYBY" "FRPC" "FRPS" "TUNSAFE" "ALIDDNS" "SMARTDNS" "SRELAY"
        )
        
        for item in "${CONFIG_ITEMS[@]}"; do
          sed -i "/CONFIG_FIRMWARE_INCLUDE_${item}/d" .config
        done
        
        # æ·»åŠ åŠŸèƒ½é…ç½®
        cat >> .config << 'EOF'
# åŸºç¡€æœåŠ¡
CONFIG_FIRMWARE_INCLUDE_MENTOHUST=n
CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=n
CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y
CONFIG_FIRMWARE_INCLUDE_SSOBFS=n
CONFIG_FIRMWARE_INCLUDE_SSSERVER=n
CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER=n

# å¹¿å‘Šè¿‡æ»¤å’Œä»£ç†
CONFIG_FIRMWARE_INCLUDE_ADBYBY=y
CONFIG_FIRMWARE_INCLUDE_KOOLPROXY=y

# å†…ç½‘ç©¿é€
CONFIG_FIRMWARE_INCLUDE_FRPC=n
CONFIG_FIRMWARE_INCLUDE_FRPS=n
CONFIG_FIRMWARE_INCLUDE_TUNSAFE=n

# DNS æœåŠ¡
CONFIG_FIRMWARE_INCLUDE_SMARTDNS=y
CONFIG_FIRMWARE_INCLUDE_SMARTDNSBIN=y
CONFIG_FIRMWARE_INCLUDE_ADGUARDHOME=y

# DDNS
CONFIG_FIRMWARE_INCLUDE_ALIDDNS=y

# å…¶ä»–æœåŠ¡
CONFIG_FIRMWARE_INCLUDE_SRELAY=n
CONFIG_FIRMWARE_INCLUDE_WYY=y
CONFIG_FIRMWARE_INCLUDE_WYYBIN=n
CONFIG_FIRMWARE_INCLUDE_ZEROTIER=n
CONFIG_FIRMWARE_INCLUDE_CADDY=y
CONFIG_FIRMWARE_INCLUDE_CADDYBIN=n

# ä»£ç†å·¥å…·
CONFIG_FIRMWARE_INCLUDE_V2RAY=n
CONFIG_FIRMWARE_INCLUDE_TROJAN=n
EOF
        
        echo "é…ç½®å®Œæˆï¼Œå¼€å§‹æ¸…ç†å’Œæ„å»º..."
        
        # æ˜¾ç¤ºæœ€ç»ˆé…ç½®
        echo "=== æœ€ç»ˆé…ç½®æ‘˜è¦ ==="
        grep "CONFIG_FIRMWARE_INCLUDE" .config | head -20
        echo "===================="
        
        # æ¸…ç†å¹¶æ„å»º
        sudo ./clear_tree
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export STAGING_DIR=/opt/rt-n56u/toolchain-mipsel/toolchain-mipsel
        
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        if sudo ./build_firmware_modify ${{ env.TNAME }} 0; then
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ!"
          # ç§»åŠ¨ç”Ÿæˆçš„å›ºä»¶
          sudo mv -f images/*.trx /opt/images/ 2>/dev/null || true
          sudo mv -f images/*.bin /opt/images/ 2>/dev/null || true
          echo "firmware_built=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥!"
          exit 1
        fi

    - name: Check build artifacts
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶..."
        if ls /opt/images/*.trx /opt/images/*.bin 2>/dev/null; then
          echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
          ls -la /opt/images/
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          # æ£€æŸ¥ images ç›®å½•
          echo "images ç›®å½•å†…å®¹:"
          ls -la /opt/rt-n56u/trunk/images/ 2>/dev/null || echo "images ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: padavan-${{ env.TNAME }}-firmware
        path: /opt/images/
        retention-days: 30

    - name: Build success notification
      if: success()
      run: |
        echo "ğŸ‰ å›ºä»¶æ„å»ºæˆåŠŸå®Œæˆ!"
        echo "è®¾å¤‡: ${{ env.TNAME }}"
        echo "å›ºä»¶æ–‡ä»¶å·²ä¸Šä¼ åˆ° Artifacts"

    - name: Build failure notification
      if: failure()
      run: |
        echo "âŒ å›ºä»¶æ„å»ºå¤±è´¥"
        echo "è®¾å¤‡: ${{ env.TNAME }}"
        echo "è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
